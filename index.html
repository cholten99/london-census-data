<html>
  <head>
    <title>London population density by borough between 1801 to 2011</title>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="http://bowsy.co.uk/london-census-data/my-css.css">
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
    <script src="//code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
    <script src="http://bowsy.co.uk/london-census-data/jquery-csv.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>

    <script>
    $(function() {
      var fusionTableId = "1WlXk5RnE3oVRtrsqnm48V75pfN66Do0nbIw2xX8";
      var googleApiKey =  "AIzaSyABknzj5RZL8YIjpZVSztvs4w61cA_o4XA";
      var census_data =[];
      var borough_maps_data;
      // The value of the "value" variable in the slider is broken so need to drive global var from the UI event (ugh!)
      var slider_value;

      // Slider
      $( "#slider" ).slider({
        value:11,
        min: 0,
        max: 21,
        step: 1,
        slide: function( event, ui ) {
          slider_value = ui.value;
          $("#year_text").html(1801 + (10 * slider_value));
          updateDataText();
        }
      });

      // Slider increment
      function slider_increment() {
        $("#slider").slider( "option", "value", slider_value);
        updateDataText();
        $("#year_text").html(1801 + (10 * slider_value));
        slider_value++;
        if (slider_value != 22) {
          setTimeout(slider_increment, 1000);
        }
      }

      // Button    
      $("#autoplay").click(function() {
        $("#year_text").html("1801");
        slider_value = 0;
        $("#slider").slider( "option", "value", slider_value );
        setTimeout(slider_increment, 1000);
      });

      function updateDataText() {
        var new_html = "";
        for (i=1; i<census_data.length; i++) {
          new_html = new_html + census_data[i][1] + " : " + census_data[i][slider_value + 2] + "<br/>";
        }
        $("#right-side").html(new_html);
      }

      // Initialisation
      function initialize() {
        // Load census data
        $.get("https://londondatastore-upload.s3.amazonaws.com/census-historic-population-borough.csv", function( data ) {
          census_data = $.csv.toArrays(data);

          $("#year_text").html("1901");
          slider_value = 11;
          updateDataText();

          // Get the map data
          sql = "SELECT * FROM " + fusionTableId;
          $.ajax({
            url: "https://www.googleapis.com/fusiontables/v1/query?sql=" + sql + "&key=" + googleApiKey,
            dataType: "json"
          }).done(function (response) {

            borough_maps_data = response;
console.log(response);

            // Draw the initial map
            var mapCanvas = document.getElementById('map-canvas');
            var mapOptions = {
              center: new google.maps.LatLng(51.49, -0.13),
              zoom: 10,
              mapTypeId: google.maps.MapTypeId.ROADMAP
            }
            var map = new google.maps.Map(mapCanvas, mapOptions)

            drawBoroughs(map);
         
          });

        });
      };
      google.maps.event.addDomListener(window, 'load', initialize);
      
      // Draw all the boroughs
      function drawBoroughs(map) {
/*
        for (rowId=2; rowId < 35; rowId++) {
          sql = "SELECT * FROM " + fusionTableId + " WHERE ROWID=" + rowId;

          $.ajax({
            url: "https://www.googleapis.com/fusiontables/v1/query?sql=" + sql + "&key=" + googleApiKey,
            dataType: "json"
          }).done(function (response) {
            drawBorough(map, response.rows[0][2].geometry.coordinates);
          });

        }
*/
      }
      
      // Draw a borough's geometry 
      function drawBorough(map, geometry) {
/*
        console.log(geometry);

        // Construct polygon
        poly = new google.maps.Polygon({
          paths: geometry,
          fillColor: '#' + ((1<<24)*Math.random()|0).toString(16),
          fillOpacity: 0.35
        });
        poly.setMap(map);
*/
      };

    }); 
    </script>

  </head>
  <body>
    <div id="all-box">
      <h2>London population density by borough between 1801 and 2011</h2>

      Prompted by <a href="https://twitter.com/resi_analyst/status/552155389777960962">this twitter post</a> by <a href="https://twitter.com/resi_analyst">@resi_analyst</a>.
      Census data from <a href="https://t.co/LJ9mNkK9lW">London Data Store</a>. Borough boundaries <a href="http://goo.gl/8fpc4y">from here</a>.
      <p/>

      <div id="top-box">
        <div class="row">
          <div class="col-md-7">
            <div id="map-canvas"></div>
          </div>
          <div id="right-side" class="col-md-3">
          </div>
        </div>
      </div>

      <p/>
        <label for="amount">Year (10 year increments):</label>
        <span id="year_text"/>
      </p>

      <div class="row">
        <div class="col-md-5">
          <div id="slider"></div>        
        </div>
        <div class="col-md-2">
          <button id="autoplay">Autoplay</button>
        </div>
    </div>
  </div>

  </body>
</html>
